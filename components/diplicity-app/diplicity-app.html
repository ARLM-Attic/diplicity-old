<link rel="import" href="/bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="/bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="/bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/bower_components/core-menu/core-menu.html">
<link rel="import" href="/bower_components/core-item/core-item.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="/bower_components/app-router/app-router.html">
<link rel="import" href="/components/my-games/my-games.html">

<polymer-element name="diplicity-app" attributes="subscriber">
  <template>
	  <style>
			core-toolbar a {
				text-decoration: none;
				font-size: x-large;
			}
		</style>
    <core-scaffold flex>
		  <core-header-panel navigation flex mode="seamed">
			  <core-toolbar>
				  <div flex>
						<a href="/">
							diplicity
						</a>
				  </div>
		    </core-toolbar>
				<core-menu>
					<template if="{{ user.Id }}">
						<a href="/logout">
							<core-item icon="lock-outline" label="Logout"></core-item>
						</a>
						<core-item icon="settings" label="{{ user.Email }}"></core-item>
					</template>
					<template if="{{ !user.Id }}">
					  <a href="{{ loginUrl }}">
				      <core-item icon="lock-open" label="Login"></core-item>
						</a>
					</template>
				</core-menu>
			</core-header-panel>
	    <div tool flex>
				<paper-tabs valueattr="path" selected="{{ path }}" self-end>
				  <paper-tab path="/games/mine">My games</paper-tab>
					<paper-tab path="/games/other">Other games</paper-tab>
					<paper-tab path="/games/create">Create game</paper-tab>
      	</paper-tabs>
      </div>
			<div flex>
				<app-router id="router" mode="pushstate" core-animated-pages transitions="cross-fade">
				  <app-route path="/games/mine" bindRouter>
					  <template>
						  <div cross-fade>
								<my-games subscriber="{{ router.templateInstance.model }}"></my-games>
							</div>
						</template>
				  </app-route>
				  <app-route path="/games/other" bindRouter>
					  <template>
						  <div cross-fade>
						    Other
							</div>
						</template>
				  </app-route>
				  <app-route path="/games/create" bindRouter>
					  <template>
						  <div cross-fade>
						    Create
							</div>
						</template>
				  </app-route>
				  <app-route path="*" redirect="/games/mine"></app-route>
        </app-router>
			</div>
		</core-scaffold>
	</template>
	<script>
		Polymer({
			message: function(message) {
				switch (message.Object.URI) {
					case '/user':
            this.user = message.Object.Data;
				}
			},
			connectWebSocket: function() {
				var that = this;
				var socketUrl = "";
				if (window.location.protocol == 'http:') {
					socketUrl = "ws://";
				} else if (window.location.protocol == 'https:') {
					socketUrl = "wss://";
				} else {
				  throw "Unknown protocol " + window.location.protocol;
				}
				socketUrl += window.location.host + "/ws";
				if (that.token != null) {
					socketUrl += "?token=" + that.token.Encoded;
				}
				if (that.socket != null) {
					that.connected = false;
					that.socket.close();
				}
				that.socket = new WebSocket(socketUrl);
				that.socket.onerror = function(options) {
					that.connected = false;
					console.log('error', options);
					that.fetchToken();
				};
				that.socket.onmessage = function(options) {
					var message = JSON.parse(options.data);
					console.log('message', message);
					var subs = that.subscriptions[message.Object.URI];
					for (var i = 0; i < subs.length; i++) {
						subs[i](message);
					}
				};
				that.socket.onopen = function(options) {
					that.connected = true;
					for (var uri in that.subscriptions) {
						var cb = that.subscriptions[uri];
						that.socket.send(JSON.stringify({"Type": "Subscribe", "Object": {"URI": uri}}));
					}
				};
				that.socket.onclose = function(options) {
					that.connected = false;
					console.log('close', options);
				};
			},
			fetchToken: function() {
				var that = this;
        $.ajax('/token', {
					success: function(data) {
						that.token = data;
						that.connectWebSocket();
					},
				});
			},
			pathChanged: function() {
				this.$.router.go(this.path);
			},
			subscribe: function(uri, cb) {
				if (this.subscriptions[uri] == null) {
					this.subscriptions[uri] = [];
				}
				this.subscriptions[uri].push(cb);
				if (this.connected) {
					this.socket.send(JSON.stringify({"Type":"Subscribe","Object":{"URI":uri}}));
				}
			},
			subscriptions: {},
			unsubscribe: function(uri, cb) {
				if (this.connected) {
					this.socket.send(JSON.stringify({"Type":"Unsubscribe","Object":{"URI":uri}}));
				}
				var newSubscriptions = [];
				for (var i = 0; i < this.subscriptions.length; i++) {
					if (this.subscriptions[i] != cb) {
						newSubscriptions.push(this.subscriptions[i]);
					}
				}
				this.subscriptions = newSubscriptions;
			},
			user: {"Id": ""},
			token: null,
			loginUrl: "",
			path: "",
			socket: null,
			connected: false,
			ready: function() {
				var that = this;
				that.loginUrl = window.location.protocol + "//" + window.location.host + "/login?return_to=" + encodeURIComponent(window.location.href);
				_.bindAll(that, 'message');
				that.subscribe("/user", that.message);
				that.path = window.location.pathname;
				if (that.path == "/") {
					that.path = "/games/mine";
				}
				that.fetchToken();
			},
		});
	</script>
</polymer-element>

